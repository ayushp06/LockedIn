if("undefined"!=typeof window){const e=document.createElement;document.createElement=function(t){const s=e.call(this,t);if("script"===t.toLowerCase()){const e=s.setAttribute;s.setAttribute=function(t,s){if("src"!==t||!s.includes("apis.google.com")&&!s.includes("recaptcha"))return e.call(this,t,s);console.warn("External script loading blocked:",s)}}return s}}(()=>{"use strict";var e,t,s={},i={};function r(e){var t=i[e];if(void 0!==t)return t.exports;var a=i[e]={exports:{}};return s[e](a,a.exports,r),a.exports}r.m=s,r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce((t,s)=>(r.f[s](e,t),t),[])),r.u=e=>({76:"common",83:"firebase-d3094b5a",96:"vendors",368:"firebase-4514f456",424:"firebase-19f9d112",515:"firebase-0520917b",977:"firebase-ab1f98e4"}[e]+".js"),r.g=function(){if("object"==typeof globalThis)return globalThis;try{return(typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:typeof window!=="undefined"?window:this)}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="lockedin-extension:",r.l=(s,i,a,o)=>{if(e[s])e[s].push(i);else{var n,c;if(void 0!==a)for(var d=document.getElementsByTagName("script"),l=0;l<d.length;l++){var h=d[l];if(h.getAttribute("src")==s||h.getAttribute("data-webpack")==t+a){n=h;break}}n||(c=!0,(n=document.createElement("script")).charset="utf-8",r.nc&&n.setAttribute("nonce",r.nc),n.setAttribute("data-webpack",t+a),n.src=s),e[s]=[i];var g=(t,i)=>{n.onerror=n.onload=null,clearTimeout(u);var r=e[s];if(delete e[s],n.parentNode&&n.parentNode.removeChild(n),r&&r.forEach(e=>e(i)),t)return t(i)},u=setTimeout(g.bind(null,void 0,{type:"timeout",target:n}),12e4);n.onerror=g.bind(null,n.onerror),n.onload=g.bind(null,n.onload),c&&document.head.appendChild(n)}},r.j=471,(()=>{var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var s=t.getElementsByTagName("script");if(s.length)for(var i=s.length-1;i>-1&&(!e||!/^http(s?):/.test(e));)e=s[i--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{var e={471:0};r.f.j=(t,s)=>{var i=r.o(e,t)?e[t]:void 0;if(0!==i)if(i)s.push(i[2]);else{var a=new Promise((s,r)=>i=e[t]=[s,r]);s.push(i[2]=a);var o=r.p+r.u(t),n=new Error;r.l(o,s=>{if(r.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var a=s&&("load"===s.type?"missing":s.type),o=s&&s.target&&s.target.src;n.message="Loading chunk "+t+" failed.\n("+a+": "+o+")",n.name="ChunkLoadError",n.type=a,n.request=o,i[1](n)}},"chunk-"+t,t)}};var t=(t,s)=>{var i,a,[o,n,c]=s,d=0;if(o.some(t=>0!==e[t])){for(i in n)r.o(n,i)&&(r.m[i]=n[i]);c&&c(r)}for(t&&t(s);d<o.length;d++)a=o[d],r.o(e,a)&&e[a]&&e[a][0](),e[a]=0},s=globalThis.webpackChunklockedin_extension=globalThis.webpackChunklockedin_extension||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})(),r.nc=void 0,console.log("LockedIn background service worker started"),new class{constructor(){this.data={workSites:["github.com","figma.com","notion.so","linear.app"],currentWorkTime:0,isWorking:!1,startTime:0,dailyWorkTime:0,lastResetDate:(new Date).toDateString()},this.isUserActive=!0,this.isSystemActive=!0,this.lastActivityTime=Date.now(),this.activityCheckInterval=null,this.initialize()}async initialize(){await this.loadData(),await this.registerContentScriptsForTrackedSites(),this.setupEventListeners(),this.startTracking(),this.resetDailyIfNeeded()}async registerContentScriptsForTrackedSites(){try{const e=await chrome.scripting.getRegisteredContentScripts(),t=new Set(e.map(e=>e.id));for(const e of this.data.workSites){const s=`lockedin-${e.replace(/\./g,"-")}`;if(t.has(s)){console.log("‚úÖ Content script already registered for:",e);continue}const i=`https://*.${e}/*`,r=`http://*.${e}/*`;await chrome.permissions.contains({origins:[i,r]})?(await chrome.scripting.registerContentScripts([{id:s,js:["content.js"],matches:[i,r],runAt:"document_end"}]),console.log("‚úÖ Registered content script for:",e)):console.log("üìã Permission needed for:",e)}}catch(e){console.error("Error registering content scripts:",e)}}async registerContentScriptForSite(e){const t=`lockedin-${e.replace(/\./g,"-")}`,s=`https://*.${e}/*`,i=`http://*.${e}/*`;try{if((await chrome.scripting.getRegisteredContentScripts()).some(e=>e.id===t))return void console.log("‚úÖ Content script already registered for:",e);if(!await chrome.permissions.contains({origins:[s,i]}))throw new Error("Permission not granted for this site");await chrome.scripting.registerContentScripts([{id:t,js:["content.js"],matches:[s,i],runAt:"document_end"}]),console.log("‚úÖ Registered content script for:",e)}catch(t){throw console.error("Failed to register content script for",e,t),t}}async loadData(){try{const e=await chrome.storage.local.get(["workTrackerData"]);e.workTrackerData&&(this.data={...this.data,...e.workTrackerData}),await this.saveData()}catch(e){console.error("Failed to load data:",e)}}async saveData(){try{await chrome.storage.local.set({workTrackerData:this.data})}catch(e){console.error("Failed to save data:",e)}}setupEventListeners(){chrome.tabs.onUpdated.addListener((e,t,s)=>{"complete"===t.status&&s.url&&this.checkWorkSite(s.url)}),chrome.tabs.onActivated.addListener(async e=>{try{const t=await chrome.tabs.get(e.tabId);t.url&&this.checkWorkSite(t.url)}catch(e){console.error("Error getting tab:",e)}}),chrome.windows.onFocusChanged.addListener(async e=>{if(e===chrome.windows.WINDOW_ID_NONE)console.log("Chrome lost focus, but continuing to track");else try{const[t]=await chrome.tabs.query({active:!0,windowId:e});t?.url&&this.checkWorkSite(t.url)}catch(e){console.error("Error checking active tab:",e)}}),chrome.idle.onStateChanged.addListener(e=>{console.log("üîî Idle state changed:",e),"active"===e?(console.log("‚úÖ System/user became active"),this.isUserActive=!0,this.isSystemActive=!0,this.lastActivityTime=Date.now(),this.checkCurrentTab()):"locked"===e?(console.log("üîí System locked/sleeping - pausing tracking"),this.isSystemActive=!1,this.pauseTracking()):"idle"===e&&(console.log("üò¥ User idle for 30+ minutes - pausing tracking"),this.isUserActive=!1,this.pauseTracking())}),chrome.runtime.onMessage.addListener((e,t,s)=>(this.handleMessage(e,t,s),!0)),chrome.runtime.onInstalled.addListener(async e=>{console.log("LockedIn extension installed/updated:",e.reason),this.setupBadge(),chrome.idle.setDetectionInterval(1800),await this.registerContentScriptsForTrackedSites()}),this.startSuspendDetection()}async checkCurrentTab(){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e?.url&&this.checkWorkSite(e.url)}catch(e){console.error("Error checking current tab:",e)}}checkWorkSite(e){const t=this.data.workSites.some(t=>e.includes(t));console.log("Checking work site:",{url:e,isWorkSite:t,isWorking:this.data.isWorking,isUserActive:this.isUserActive,isSystemActive:this.isSystemActive,workSites:this.data.workSites}),t&&!this.data.isWorking&&this.isSystemActive?(console.log("Starting work - work site and system active"),this.startWork()):t&&this.isSystemActive||!this.data.isWorking||(console.log("Stopping work - conditions not met:",{isWorkSite:t,isSystemActive:this.isSystemActive}),this.stopWork())}pauseTracking(){this.data.isWorking&&(console.log("‚è∏Ô∏è Pausing tracking due to inactivity/sleep"),this.stopWork())}startWork(){this.data.isWorking=!0,this.data.startTime=Date.now(),this.updateBadge("ON"),console.log("‚ñ∂Ô∏è Started working at",(new Date).toLocaleTimeString())}stopWork(){if(this.data.isWorking){const e=Date.now()-this.data.startTime;this.data.currentWorkTime+=e,this.data.dailyWorkTime+=e,this.data.isWorking=!1,this.updateBadge("OFF"),this.saveData(),this.syncToFirebase(),console.log("‚èπÔ∏è Stopped working. Added",Math.round(e/1e3),"seconds. Daily total:",Math.round(this.data.dailyWorkTime/1e3/60),"minutes")}}updateBadge(e){chrome.action.setBadgeText({text:e}),chrome.action.setBadgeBackgroundColor({color:"ON"===e?"#10b981":"#6b7280"})}setupBadge(){chrome.action.setBadgeText({text:"OFF"}),chrome.action.setBadgeBackgroundColor({color:"#6b7280"})}startSuspendDetection(){this.activityCheckInterval=setInterval(()=>{const e=Date.now(),t=e-this.lastActivityTime;if(t>1e4){if(console.log("‚ö†Ô∏è System suspend/sleep detected! Time gap:",Math.round(t/1e3),"seconds"),this.data.isWorking){const e=this.lastActivityTime-this.data.startTime;e>0&&(this.data.currentWorkTime+=e,this.data.dailyWorkTime+=e,console.log("‚úÖ Saved",Math.round(e/1e3),"seconds of work before sleep")),this.data.isWorking=!1,this.updateBadge("OFF"),this.saveData(),this.syncToFirebase()}this.isSystemActive=!0,this.checkCurrentTab()}this.lastActivityTime=e},5e3)}startTracking(){setInterval(()=>{if(this.data.isWorking&&this.isSystemActive){const e=Date.now()-this.data.startTime;this.data.currentWorkTime+=e,this.data.dailyWorkTime+=e,this.data.startTime=Date.now(),this.saveData(),this.syncToFirebase(),console.log("‚è±Ô∏è Tracking active - Daily time:",Math.round(this.data.dailyWorkTime/1e3/60),"minutes")}else this.data.isWorking&&!this.isSystemActive&&this.pauseTracking()},5e3),setInterval(()=>{this.data.userId&&this.data.dailyWorkTime>0&&this.syncToFirebase()},3e4),chrome.idle.setDetectionInterval(1800)}resetDailyIfNeeded(){const e=(new Date).toDateString();this.data.lastResetDate!==e&&(this.data.dailyWorkTime=0,this.data.lastResetDate=e,this.saveData(),this.syncToFirebase(),this.resetStreaksForInactiveUsers())}async resetStreaksForInactiveUsers(){try{const{DailyStatsService:e}=await Promise.all([r.e(977),r.e(424),r.e(515),r.e(368),r.e(83),r.e(96),r.e(76)]).then(r.bind(r,6164));await e.resetStreakForInactiveUsers(),console.log("Daily streak reset completed")}catch(e){console.error("Failed to reset streaks for inactive users:",e)}}async syncToFirebase(){if(this.data.userId)try{chrome.runtime.sendMessage({action:"syncDailyStats",userId:this.data.userId,dailyWorkTime:this.data.dailyWorkTime}).catch(()=>{console.log("Popup not open, skipping sync message")})}catch(e){console.error("Failed to sync to Firebase:",e)}}async handleMessage(e,t,s){try{switch(e.action){case"pageVisible":e.url&&this.checkWorkSite(e.url),s({success:!0});break;case"pageHidden":"navigation"!==e.reason&&"tab_switch"!==e.reason||this.pauseTracking(),s({success:!0});break;case"userActivity":this.isUserActive=!0,this.lastActivityTime=Date.now(),e.url&&this.checkWorkSite(e.url),s({success:!0});break;case"getWorkTime":s({workTime:this.data.currentWorkTime,dailyWorkTime:this.data.dailyWorkTime,isWorking:this.data.isWorking});break;case"getWorkSites":s({workSites:this.data.workSites});break;case"addWorkSite":if(e.site&&!this.data.workSites.includes(e.site))try{this.data.workSites.push(e.site),await this.saveData(),await this.registerContentScriptForSite(e.site),s({success:!0})}catch(t){console.error("Error adding work site:",t),this.data.workSites=this.data.workSites.filter(t=>t!==e.site),await this.saveData(),s({success:!1,error:"Failed to register permissions"})}else s({success:!1,error:"Site already exists or invalid"});break;case"removeWorkSite":try{this.data.workSites=this.data.workSites.filter(t=>t!==e.site),await this.saveData();const t=`lockedin-${e.site.replace(/\./g,"-")}`;await chrome.scripting.unregisterContentScripts({ids:[t]}),console.log("üóëÔ∏è Unregistered content script for:",e.site),s({success:!0})}catch(e){console.error("Error removing work site:",e),s({success:!1,error:"Failed to unregister"})}break;case"getStatus":s({isWorking:this.data.isWorking,workSites:this.data.workSites,dailyWorkTime:this.data.dailyWorkTime});break;case"setUserId":this.data.userId=e.userId,await this.saveData(),s({success:!0});break;case"getUserId":s({userId:this.data.userId});break;case"syncToFirebase":this.syncToFirebase(),s({success:!0});break;default:s({error:"Unknown action"})}}catch(e){console.error("Error handling message:",e),s({error:"Internal error"})}}}})();